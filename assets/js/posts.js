// Generated by CoffeeScript 1.10.0
(function() {
  var añadirPost, añadirPosts, enterT, esVisible, findNum, hideReturnIcon, leaveT, loadPost, oldScrollPos, postsInfo, returnMainPage, showReturnIcon, smoothScroll, tapped, translateDay, translateMonth, twitterIntentUrl;

  translateDay = function(day) {
    var dia;
    dia = day;
    switch (day) {
      case 'Mon':
        dia = 'Lun';
        break;
      case 'Tue':
        dia = 'Mar';
        break;
      case 'Wed':
        dia = 'Mié';
        break;
      case 'Thu':
        dia = 'Jue';
        break;
      case 'Fri':
        dia = 'Vié';
        break;
      case 'Sat':
        dia = 'Sáb';
        break;
      case 'Sun':
        dia = 'Dom';
    }
    return dia;
  };

  translateMonth = function(month) {
    var mes;
    mes = month;
    switch (month) {
      case 'Jan':
        mes = 'Ene';
        break;
      case 'Apr':
        mes = 'Abr';
        break;
      case 'Aug':
        mes = 'Ago';
        break;
      case 'Dec':
        mes = 'Dic';
    }
    return mes;
  };

  postsInfo = void 0;

  showReturnIcon = function() {
    return $('.circle-button').css('opacity', 1).removeClass('hide').addClass('show');
  };

  hideReturnIcon = function() {
    $('.circle-button').removeClass('show').addClass('hide');
    return setTimeout(function() {
      return $('.circle-button').css('opacity', 0);
    }, 1000);
  };

  smoothScroll = function(from, to, cbk) {
    var done, position, target, tween, update;
    position = {
      x: 0,
      y: from
    };
    target = {
      x: 0,
      y: to
    };
    done = false;
    tween = new TWEEN.Tween(position).to(target, from - to === 0 ? 0 : Math.log2(Math.abs(from - to)) * 100);
    tween.easing(TWEEN.Easing.Cubic.InOut);
    tween.onUpdate(function() {
      return window.scrollTo(position.x, position.y);
    });
    tween.onComplete(function() {
      done = true;
      if (cbk != null) {
        return cbk();
      }
    });
    tween.start();
    update = function() {
      TWEEN.update();
      if (!done) {
        return window.requestAnimationFrame(update);
      }
    };
    return update();
  };

  oldScrollPos = 0;

  loadPost = function(num) {
    var post;
    num = Number(num);
    post = postsInfo[num];
    oldScrollPos = window.scrollY;
    return smoothScroll(oldScrollPos, 0, function() {
      $('.mainPage').removeClass('show').addClass('_hide');
      showReturnIcon();
      return $.get(post.url, function(html) {
        $('.postPage').append(html).removeClass('_hide').addClass('show').css('position', 'absolute');
        window.location.hash = "#" + post.url;
        $('#share-tw a').attr('href', twitterIntentUrl('melchor629', window.location, "\"" + post.titulo + "\""));
        $('title').text(post.titulo + " - The abode of melchor9000");
        return setTimeout(function() {
          $('.mainPage').hide();
          $('.postPage').css('position', 'relative');
          return $('img').attr('data-action', 'zoom');
        }, 500);
      }).fail(function(error) {
        alert('Post no existente');
        return returnMainPage();
      });
    });
  };

  returnMainPage = function() {
    $('.postPage').removeClass('show').addClass('_hide');
    $('.mainPage').removeClass('_hide').addClass('show').show();
    hideReturnIcon();
    window.location.hash = "";
    return setTimeout(function() {
      $('.postPage').empty();
      smoothScroll(0, oldScrollPos);
      return $('title').text("Posts - The abode of melchor9000");
    }, 500);
  };

  twitterIntentUrl = function(username, url, text) {
    return "http://twitter.com/intent/tweet?text=" + (encodeURIComponent(text)) + "& url=" + (encodeURIComponent(url)) + "&via=" + username + "&related=" + username + "%3AMelchor%20Garau%20Madrigal";
  };

  findNum = function(url) {
    var i, j, ref;
    for (i = j = 0, ref = postsInfo.length; 0 <= ref ? j <= ref : j >= ref; i = 0 <= ref ? ++j : --j) {
      if (postsInfo[i].url === url) {
        return i;
      }
    }
  };

  esVisible = function(v) {
    var height, position, postHeight, scrollTop;
    scrollTop = window.scrollY;
    height = $(window).height();
    position = 80 + $(v).position().top;
    postHeight = $(v).height();
    return position < scrollTop + height && position + postHeight >= scrollTop;
  };

  añadirPosts = function(linea) {
    var i, int, j, l, len, m, numOfPostsPerLine, ref, ref1, ref2, ref3, results, results1, results2;
    numOfPostsPerLine = 1;
    if ($(window).width() >= 768 && $(window).width() <= 1199) {
      numOfPostsPerLine = 2;
    } else if ($(window).width() >= 1200) {
      numOfPostsPerLine = 3;
    }
    postsInfo.linea = linea;
    postsInfo.cargados = (linea + 1) * numOfPostsPerLine;
    if (postsInfo.cargados > postsInfo.length) {
      postsInfo.cargados = postsInfo.length;
      int = (function() {
        results = [];
        for (var j = ref = linea * numOfPostsPerLine, ref1 = postsInfo.length - 1; ref <= ref1 ? j <= ref1 : j >= ref1; ref <= ref1 ? j++ : j--){ results.push(j); }
        return results;
      }).apply(this);
    } else {
      int = (function() {
        results1 = [];
        for (var l = ref2 = linea * numOfPostsPerLine, ref3 = (linea + 1) * numOfPostsPerLine - 1; ref2 <= ref3 ? l <= ref3 : l >= ref3; ref2 <= ref3 ? l++ : l--){ results1.push(l); }
        return results1;
      }).apply(this);
    }
    results2 = [];
    for (m = 0, len = int.length; m < len; m++) {
      i = int[m];
      results2.push(añadirPost(i));
    }
    return results2;
  };

  añadirPost = function(num) {
    var dia, fecha, fechaPartes, info, innerOuter, mes, post, postEntry, postThumb, postThumbLink, title, titleLink;
    post = postsInfo[num];
    postEntry = $('<div/>').addClass('post_entry col-sm-6 col-lg-4').data('num', num);
    innerOuter = $('<div/>').addClass('inner-outer');
    postThumb = $('<div/>').addClass('post_thumb').css('background-image', "url('" + post.img + "')");
    postThumbLink = $('<a/>').attr('href', post.url).append($('<div/>').addClass('cover')).addClass('post_url');
    title = $('<h3/>').addClass('text-center post_title');
    titleLink = $('<a/>').attr('href', post.url).addClass('post_url').text(post.titulo);
    fechaPartes = /^(\w{3}), \d\d (\w{3}).+$/i.exec(post.fecha);
    dia = translateDay(fechaPartes[1]);
    mes = translateMonth(fechaPartes[2]);
    fecha = post.fecha.replace(fechaPartes[1], dia).replace(fechaPartes[2], mes);
    info = $('<div/>').addClass('post_info').append("<small><p class=\"text-right post_created_time\">" + fecha + "</p></small>");
    postThumb.append(postThumbLink);
    title.append(titleLink);
    innerOuter.append(postThumb).append(title).append(info);
    postEntry.append(innerOuter);
    postEntry.find('.post_url').click(function(e) {
      e.preventDefault();
      loadPost($(this).closest('.post_entry').data('num'));
      return false;
    });
    return $('.posts_container').append(postEntry);
  };

  $('.circle-button.back').click(function() {
    returnMainPage();
    return false;
  });

  enterT = void 0;

  leaveT = void 0;

  tapped = false;

  $('.circle-button-group.share').mouseenter(function() {
    $(this).find('.circle-button-extra').css('display', 'block');
    clearTimeout(leaveT);
    return enterT = setTimeout((function(_this) {
      return function() {
        return $(_this).find('.circle-button-extra').addClass('hover').animate({
          top: '-45px'
        }, 300);
      };
    })(this), 20);
  }).mouseleave(function() {
    $(this).find('.circle-button-extra').removeClass('hover').each(function(k, v) {
      return $(v).animate({
        top: (-73 - 48 * k) + "px"
      }, 300);
    });
    clearTimeout(enterT);
    return leaveT = setTimeout((function(_this) {
      return function() {
        return $(_this).find('.circle-button-extra').css('display', 'none');
      };
    })(this), 333);
  });

  $('.circle-button.share').on('tap', function() {
    if (tapped) {
      $('.circle-button-group.share').trigger('mouseleave');
      return tapped = false;
    } else {
      $('.circle-button-group.share').trigger('mouseenter');
      return tapped = true;
    }
  });

  $('.circle-button-group.share .circle-button-extra').each(function(k, v) {
    return $(v).css('top', (-73 - 48 * k) + "px");
  });

  $('#share-fb').click(function(e) {
    return FB.ui({
      method: 'share',
      href: window.location.toString()
    }, function(response) {
      return console.log(response);
    });
  });

  $.get('/assets/posts.json').success(function(data) {
    postsInfo = data;
    postsInfo.pop();
    añadirPosts(0);
    $(window).scroll();
    if (window.location.hash !== "") {
      return loadPost(findNum(decodeURIComponent(window.location.hash.substr(1))));
    }
  });

  $(window).scroll(function(e) {
    var abajoPos;
    if ($('.mainPage').hasClass('_hide')) {
      return;
    }
    abajoPos = window.scrollY + $(window).height();
    if (abajoPos > $('.posts_container').height() + 70 && postsInfo.length !== postsInfo.cargados) {
      return añadirPosts(postsInfo.linea + 1);
    } else if (postsInfo.length === postsInfo.cargados) {
      $(window).off('scroll');
      return $(window).off('resize');
    }
  });

  $(window).resize(function(e) {
    return $(window).scroll();
  });

}).call(this);
