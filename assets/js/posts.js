// Generated by CoffeeScript 1.9.3
(function() {
  var findNum, hideReturnIcon, loadPost, oldScrollPos, postsInfo, returnMainPage, showReturnIcon, smoothScroll, translateDay, translateMonth, twitterIntentUrl;

  translateDay = function(day) {
    var dia;
    dia = day;
    switch (day) {
      case 'Mon':
        dia = 'Lun';
        break;
      case 'Tue':
        dia = 'Mar';
        break;
      case 'Wed':
        dia = 'Mié';
        break;
      case 'Thu':
        dia = 'Jue';
        break;
      case 'Fri':
        dia = 'Vié';
        break;
      case 'Sat':
        dia = 'Sáb';
        break;
      case 'Sun':
        dia = 'Dom';
    }
    return dia;
  };

  translateMonth = function(month) {
    var mes;
    mes = month;
    switch (month) {
      case 'Jan':
        mes = 'Ene';
        break;
      case 'Apr':
        mes = 'Abr';
        break;
      case 'Aug':
        mes = 'Ago';
        break;
      case 'Dec':
        mes = 'Dic';
    }
    return mes;
  };

  postsInfo = void 0;

  showReturnIcon = function() {
    return $('.circle-button').css('opacity', 1).removeClass('hide').addClass('show');
  };

  hideReturnIcon = function() {
    $('.circle-button').removeClass('show').addClass('hide');
    return setTimeout(function() {
      return $('.circle-button').css('opacity', 0);
    }, 1000);
  };

  smoothScroll = function(from, to, duration, cbk) {
    var done, position, target, tween, update;
    position = {
      x: 0,
      y: from
    };
    target = {
      x: 0,
      y: to
    };
    done = false;
    tween = new TWEEN.Tween(position).to(target, duration);
    tween.easing(TWEEN.Easing.Cubic.InOut);
    tween.onUpdate(function() {
      return window.scrollTo(position.x, position.y);
    });
    tween.onComplete(function() {
      done = true;
      if (cbk != null) {
        return cbk();
      }
    });
    tween.start();
    update = function() {
      TWEEN.update();
      if (!done) {
        return window.requestAnimationFrame(update);
      }
    };
    return update();
  };

  oldScrollPos = 0;

  loadPost = function(num) {
    var post;
    num = Number(num);
    post = postsInfo[num];
    oldScrollPos = window.scrollY;
    return smoothScroll(oldScrollPos, 0, 500, function() {
      $('.mainPage').removeClass('show').addClass('_hide');
      showReturnIcon();
      return $.get(post.url, function(html) {
        $('.postPage').append(html).removeClass('_hide').addClass('show').css('position', 'absolute');
        window.location.hash = "#" + post.url;
        $('#share-tw a').attr('href', twitterIntentUrl('melchor629', window.location, "\"" + post.titulo + "\""));
        $('title').text(post.titulo + " - The abode of melchor9000");
        return setTimeout(function() {
          $('.mainPage').hide();
          return $('.postPage').css('position', 'relative');
        }, 500);
      }).fail(function(error) {
        alert('Post no existente');
        return returnMainPage();
      });
    });
  };

  returnMainPage = function() {
    $('.postPage').removeClass('show').addClass('_hide');
    $('.mainPage').removeClass('_hide').addClass('show').show();
    hideReturnIcon();
    window.location.hash = "";
    return setTimeout(function() {
      $('.postPage').empty();
      smoothScroll(0, oldScrollPos, 1000);
      return $('title').text("Posts - The abode of melchor9000");
    }, 500);
  };

  twitterIntentUrl = function(username, url, text) {
    return "http://twitter.com/intent/tweet?text=" + (encodeURIComponent(text)) + "& url=" + (encodeURIComponent(url)) + "&via=" + username + "&related=" + username + "%3AMelchor%20Garau%20Madrigal";
  };

  findNum = function(url) {
    var i, j, ref;
    for (i = j = 0, ref = postsInfo.length; 0 <= ref ? j <= ref : j >= ref; i = 0 <= ref ? ++j : --j) {
      if (postsInfo[i].url === url) {
        return i;
      }
    }
  };

  (function() {
    var enterT, leaveT, tapped;
    $('.post_created_time').each(function(k, v) {
      var dia, mes, parts;
      v = $(v);
      parts = /^(\w{3}), \d\d (\w{3}).+$/i.exec(v.text());
      dia = translateDay(parts[1]);
      mes = translateMonth(parts[2]);
      return v.text(v.text().replace(parts[1], dia).replace(parts[2], mes));
    });
    $('.post_url').click(function(e) {
      e.preventDefault();
      loadPost($(this).closest('.post_entry').data('num'));
      return false;
    });
    $('.circle-button.back').click(function() {
      returnMainPage();
      return false;
    });
    enterT = void 0;
    leaveT = void 0;
    tapped = false;
    $('.circle-button-group.share').mouseenter(function() {
      $(this).find('.circle-button-extra').css('display', 'block');
      clearTimeout(leaveT);
      return enterT = setTimeout((function(_this) {
        return function() {
          return $(_this).find('.circle-button-extra').addClass('hover').animate({
            top: '-45px'
          }, 300);
        };
      })(this), 20);
    }).mouseleave(function() {
      $(this).find('.circle-button-extra').removeClass('hover').each(function(k, v) {
        return $(v).animate({
          top: (-73 - 48 * k) + "px"
        }, 300);
      });
      clearTimeout(enterT);
      return leaveT = setTimeout((function(_this) {
        return function() {
          return $(_this).find('.circle-button-extra').css('display', 'none');
        };
      })(this), 333);
    });
    $('.circle-button.share').on('tap', function() {
      if (tapped) {
        $('.circle-button-group.share').trigger('mouseleave');
        return tapped = false;
      } else {
        $('.circle-button-group.share').trigger('mouseenter');
        return tapped = true;
      }
    });
    $('.circle-button-group.share .circle-button-extra').each(function(k, v) {
      return $(v).css('top', (-73 - 48 * k) + "px");
    });
    $('#share-fb').click(function(e) {
      return FB.ui({
        method: 'share',
        href: window.location.toString()
      }, function(response) {
        return console.log(response);
      });
    });
    return $.get('/assets/posts.json').success(function(data) {
      postsInfo = data;
      if (window.location.hash !== "") {
        return loadPost(findNum(decodeURIComponent(window.location.hash.substr(1))));
      }
    });
  })();

}).call(this);
