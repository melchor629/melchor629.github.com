// Generated by CoffeeScript 1.10.0
(function() {
  var CuriousPromise, FlickrGallery;

  CuriousPromise = (function() {
    function CuriousPromise(numOfDoneCalls, cbk) {
      this.num = numOfDoneCalls;
      this.cbk = cbk;
      this.doneCalls = 0;
    }

    CuriousPromise.prototype.done = function() {
      this.doneCalls++;
      if (this.num === this.doneCalls) {
        return this.cbk();
      }
    };

    return CuriousPromise;

  })();

  FlickrGallery = (function() {
    function FlickrGallery(opt) {
      this.photosPerPage = opt.photosPerPage || 12;
      this.container = opt.container || $('.gallery-container') || $('#gallery-container');
      this.userId = opt.userId;
      this.photosetId = opt.photosetId;
      if (!this.userId) {
        throw "userId is not set for FlickrGallery";
      }
      if (!this.photosetId) {
        throw "photosetId is not set for FlickrGallery";
      }
      if (!this.container) {
        throw "Container not found, select a valid one";
      }
      this.page = 0;
      this.totalPages = 1;
      this.loadingMorePhotos = false;
      this.photos = [];
      this.photoInfo = {};
      this.currentPhoto = null;
      this._curiousPromise = null;
      this._setUpListeners();
      this.loadMorePhotos();
    }

    FlickrGallery.prototype.loadMorePhotos = function() {
      if (this.page === this.totalPages) {
        this.$('.load-spin-container').hide();
        return;
      }
      this.loadingMorePhotos = true;
      this.page++;
      return flickr.photosets.getPhotos({
        user_id: this.userId,
        photoset_id: this.photosetId,
        per_page: this.photosPerPage,
        page: this.page
      }, (function(_this) {
        return function(json) {
          var i, len, photo, photoNum, ref;
          _this._setHeaderImageBackground(json.photoset.primary);
          _this.totalPages = json.photoset.pages;
          photoNum = 0;
          ref = json.photoset.photo;
          for (i = 0, len = ref.length; i < len; i++) {
            photo = ref[i];
            _this.photos.push(photo);
            _this.$('.gallery').append($('<div/>').addClass('col-xs-6').addClass('col-sm-4').addClass('col-md-3').append($('<div/>').css({
              'background-image': "url(" + (flickr.buildPhotoUrl(photo)) + ")"
            }).append($('<div/>').append($('<div/>').text(photo.title).addClass('photo-title'))).data('num', _this.photos.length - 1).click(function(e) {
              e.preventDefault();
              _this.showPhoto(_this.$(e.delegateTarget).data('num'));
              return false;
            })));
            photoNum++;
          }
          $(window).resize();
          _this.$('.photo-overlay').find('div.next').show();
          return _this.loadingMorePhotos = false;
        };
      })(this));
    };

    FlickrGallery.prototype.showPhoto = function(num, dir) {
      $('body').css('overflow', 'hidden');
      this.$('.photo-overlay').find('img').attr('src', flickr.buildLargePhotoUrl(this.photos[num]));
      this.$('.photo-overlay').find('.image-info').find('h2').text(this.photos[num].title);
      this.$('.photo-overlay').removeClass('hide').addClass('show');
      this.$('.buttons-container').find('.next').css('left', this.$('.image-view').width() - 70);
      this._loadPhotoImage(this.photos[num], dir);
      this.currentPhoto = num;
      if (this.currentPhoto === 0) {
        this.$('.photo-overlay').find('div.prev').hide();
      } else {
        this.$('.photo-overlay').find('div.prev').show();
      }
      if (this.currentPhoto === this.photos.length - 1) {
        this.$('.photo-overlay').find('div.next').hide();
      } else {
        this.$('.photo-overlay').find('div.next').show();
      }
      if (this.currentPhoto === this.photos.length - 1 && this.page < this.totalPages) {
        this.loadMorePhotos();
      }
      if (this.page === this.totalPages) {
        return this.$('.load-spin-container').show();
      }
    };

    FlickrGallery.prototype.hideOverlay = function() {
      this.currentPhoto = null;
      $('body').css('overflow', 'inherit');
      this.$('.photo-overlay').removeClass('show');
      setTimeout(function() {
        this.$('.photo-overlay').addClass('hide');
        this.$('.photo-overlay').find('#fecha').find('span').text('');
        return this.$('.photo-overlay').find('#camara').find('span').text('');
      }, 500);
      if (this.page === this.totalPages) {
        return this.$('.load-spin-container').hide();
      }
    };

    FlickrGallery.prototype.toggleInfoPanel = function() {
      if (this.$('.photo-overlay').find('.image-info').hasClass('min-size')) {
        this.$('.photo-overlay').find('.image-info').removeClass('min-size');
        this.$('.photo-overlay').find('.image-view').removeClass('max-size');
        return this.$('.buttons-container').find('.next').css('left', $(window).width() * 0.6666666666666666666 - 70);
      } else {
        this.$('.photo-overlay').find('.image-info').addClass('min-size');
        this.$('.photo-overlay').find('.image-view').addClass('max-size');
        return this.$('.buttons-container').find('.next').css('left', $(window).width() - 70);
      }
    };

    FlickrGallery.prototype.nextImage = function() {
      if (this.currentPhoto !== null && this.currentPhoto < this.photos.length - 1) {
        return this.showPhoto(this.currentPhoto + 1, 'next');
      }
    };

    FlickrGallery.prototype.previousImage = function() {
      if (this.currentPhoto !== null && this.currentPhoto > 0) {
        return this.showPhoto(this.currentPhoto - 1, 'prev');
      }
    };

    FlickrGallery.prototype.zoomImage = function() {
      return flickr.photos.getSizes({
        photo_id: this.photos[this.currentPhoto].id
      }, (function(_this) {
        return function(json) {
          var i, len, ref, s, size;
          size = null;
          ref = json.sizes.size;
          for (i = 0, len = ref.length; i < len; i++) {
            s = ref[i];
            if (s.label === "Large") {
              size = s;
            } else if (s.label === "Original") {
              size = s;
              break;
            }
          }
          _this.$('.zoom-container > .zoom-image-view').css({
            'background-image': "url(" + size.source + ")",
            width: Number(size.width),
            height: Number(size.height)
          });
          return _this.$('.zoom-container').removeClass('hide').scrollLeft(size.width / 2).scrollTop(size.height / 2);
        };
      })(this));
    };

    FlickrGallery.prototype.hideZoomImage = function() {
      this.$('.zoom-container > .zoom-image-view').css('background-image', null);
      return this.$('.zoom-container').addClass('hide');
    };

    FlickrGallery.prototype._loadPhotoImage = function(photo, dir) {
      var _curiousPromise, exifFunc, infoFunc;
      infoFunc = function(data) {
        var date, sd;
        if (data.stat === "ok") {
          sd = data.photo.dates.taken.split(/[-: ]/);
          date = new Date(sd[0], sd[1], sd[2], sd[3], sd[4], sd[5], 0);
          this.$('.photo-overlay').find('#descripcion').text(data.photo.description._content).show();
          this.$('.photo-overlay').find('#fecha').show().find('span').text(date.toLocaleString());
          return this.$('.photo-overlay').find('#enlace').find('a').attr('href', data.photo.urls.url[0]._content).show();
        } else {
          this.$('.photo-overlay').find('#descripcion').hide();
          this.$('.photo-overlay').find('#fecha').hide();
          return this.$('.photo-overlay').find('#enlace').hide();
        }
      };
      exifFunc = function(data) {
        var apertura, distFocal, exposicion, flash, i, iso, len, ref, tag;
        exposicion = null;
        apertura = null;
        iso = null;
        distFocal = null;
        flash = null;
        ref = data.photo.exif;
        for (i = 0, len = ref.length; i < len; i++) {
          tag = ref[i];
          if (tag.tagspace === 'ExifIFD') {
            if (tag.tag === 'ExposureTime') {
              exposicion = tag.raw._content;
            }
            if (tag.tag === 'FNumber') {
              apertura = tag.raw._content;
            }
            if (tag.tag === 'ISO') {
              iso = tag.raw._content;
            }
            if (tag.tag === 'FocalLength') {
              distFocal = tag.raw._content;
            }
            if (tag.tag === 'Flash') {
              flash = tag.raw._content;
            }
          }
        }
        if (data.stat === "ok") {
          this.$('.photo-overlay').find('#camara').show().find('span').text(data.photo.camera);
        } else {
          this.$('.photo-overlay').find('#camara').hide();
        }
        if (exposicion) {
          this.$('.photo-overlay').find('#exposicion').show().find('span').text(exposicion);
        } else {
          this.$('.photo-overlay').find('#exposicion').hide();
        }
        if (apertura) {
          this.$('.photo-overlay').find('#apertura').show().find('span').text(apertura);
        } else {
          this.$('.photo-overlay').find('#apertura').hide();
        }
        if (iso) {
          this.$('.photo-overlay').find('#iso').show().find('span').text(iso);
        } else {
          this.$('.photo-overlay').find('#iso').hide();
        }
        if (distFocal) {
          this.$('.photo-overlay').find('#dist-focal').show().find('span').text(distFocal);
        } else {
          this.$('.photo-overlay').find('#dist-focal').hide();
        }
        if (flash) {
          if (flash.indexOf('Off' !== -1)) {
            return this.$('.photo-overlay').find('#flash').show().find('span').text('Apagado, no se disparó');
          } else {
            return this.$('.photo-overlay').find('#flash').show().find('span').text('Encendido, se disparó');
          }
        } else {
          return this.$('.photo-overlay').find('#flash').hide();
        }
      };
      _curiousPromise = new CuriousPromise(3, (function(_this) {
        return function() {
          infoFunc(_this.photoInfo[photo.id].info);
          exifFunc(_this.photoInfo[photo.id].exif);
          _this._imageTransition(photo, dir);
          _this._curiousPromise = null;
          return _this.$('.load-spin-container').removeClass('overlay-loading');
        };
      })(this));
      this.$('.load-spin-container').addClass('overlay-loading');
      this.$('.photo-overlay').find('img').imagesLoaded((function(_this) {
        return function() {
          return _curiousPromise.done();
        };
      })(this));
      if (this.photoInfo[photo.id] && this.photoInfo[photo.id].info) {
        _curiousPromise.done();
      } else {
        flickr.photos.getInfo({
          photo_id: photo.id,
          secret: photo.secret
        }, (function(_this) {
          return function(data) {
            if (_this.photoInfo[photo.id]) {
              _this.photoInfo[photo.id].info = data;
            } else {
              _this.photoInfo[photo.id] = {
                info: data
              };
            }
            return _curiousPromise.done();
          };
        })(this));
      }
      if (this.photoInfo[photo.id] && this.photoInfo[photo.id].exif) {
        return _curiousPromise.done();
      } else {
        return flickr.photos.getExif({
          photo_id: photo.id,
          secret: photo.secret
        }, (function(_this) {
          return function(data) {
            if (_this.photoInfo[photo.id]) {
              _this.photoInfo[photo.id].exif = data;
            } else {
              _this.photoInfo[photo.id] = {
                exif: data
              };
            }
            return _curiousPromise.done();
          };
        })(this));
      }
    };

    FlickrGallery.prototype._imageTransition = function(photo, dir) {
      var initialBackgroundPos, oldImage;
      oldImage = this.$('.photo-overlay').find('.img').css('background-image');
      if (oldImage && oldImage !== 'none') {
        if (dir) {
          initialBackgroundPos = dir === 'next' ? '60% 50%' : '40% 50%';
        } else {
          initialBackgroundPos = 'center';
        }
        this.$('.photo-overlay').find('#img').css({
          'background-image': "url('" + (flickr.buildLargePhotoUrl(photo)) + "')",
          'background-position': initialBackgroundPos,
          opacity: '0'
        }).parent().find('#img2').css({
          'background-image': "" + oldImage,
          'background-position': 'center',
          opacity: '1',
          display: 'block'
        });
        return new AnimationTimer(250, (function(_this) {
          return function(t) {
            var p, pos1, pos2;
            p = -(Math.cos(Math.PI * t) - 1) / 2;
            if (dir) {
              pos1 = dir === 'next' ? 60 - 10 * t : 40 + 10 * t;
              pos2 = dir === 'next' ? 50 - 10 * t : 50 + 10 * t;
            } else {
              pos1 = pos2 = 50;
            }
            _this.$('.photo-overlay').find('#img').css({
              'opacity': "" + p,
              'background-position': pos1 + "% 50%"
            });
            return _this.$('.photo-overlay').find('#img2').css({
              'opacity': "" + (1 - p),
              'background-position': pos2 + "% 50%"
            });
          };
        })(this), true).onEnd((function(_this) {
          return function() {
            return _this.$('.photo-overlay').find('#img2').hide().parent().find('#img').css('opacity', '1');
          };
        })(this));
      } else {
        return this.$('.photo-overlay').find('.img').css('background-image', "url('" + (flickr.buildLargePhotoUrl(photo)) + "')");
      }
    };

    FlickrGallery.prototype._setHeaderImageBackground = function(photoId) {
      if (this.$('.image-background').css('background-image') === 'none') {
        return flickr.photos.getSizes({
          photo_id: photoId
        }, function(json) {
          var i, img, len, ref, size;
          if (json.stat === 'ok') {
            img = null;
            ref = json.sizes.size;
            for (i = 0, len = ref.length; i < len; i++) {
              size = ref[i];
              if (size.label === 'Large') {
                img = size.source;
                break;
              }
            }
            return this.$('.image-background').parallax({
              imageSrc: img
            });
          }
        });
      }
    };

    FlickrGallery.prototype._setUpListeners = function() {
      $(window).scroll((function(_this) {
        return function() {
          var bottom, sizeOfPage;
          bottom = _this.$(window).scrollTop() + _this.$(window).height();
          sizeOfPage = $(_this.container).parent().height();
          if (sizeOfPage - bottom < 100 && !_this.loadingMorePhotos) {
            return _this.loadMorePhotos();
          }
        };
      })(this));
      $(window).resize(function() {
        return this.$('.gallery > div > div').each((function(_this) {
          return function(k, v) {
            return _this.$(v).height(_this.$(v).width());
          };
        })(this));
      });
      $(window).keyup((function(_this) {
        return function(e) {
          if (_this.$('.photo-overlay').hasClass('show')) {
            if (e.keyCode === 27) {
              if (_this.$('.zoom-container').hasClass('hide')) {
                return _this.hideOverlay();
              } else {
                return _this.hideZoomImage();
              }
            } else if (e.keyCode === 39) {
              return _this.nextImage();
            } else if (e.keyCode === 37) {
              return _this.previousImage();
            } else if (e.keyCode === 32) {
              return console.log(null);
            }
          }
        };
      })(this));
      this.$('.image-view').mousemove((function(_this) {
        return function() {
          _this.$('.photo-overlay').find('.buttons-container').removeClass('no-move');
          return _this._timer.restart();
        };
      })(this));
      this._timer = new Timer(3000, (function(_this) {
        return function() {
          return _this.$('.photo-overlay').find('.buttons-container').addClass('no-move');
        };
      })(this), true);
      this.$('.photo-overlay').find('#close').click(this.hideOverlay.bind(this)).parent().find('#info').click(this.toggleInfoPanel.bind(this));
      this.$('.photo-overlay').find('#zoom').click(this.zoomImage.bind(this));
      this.$('.photo-overlay').find('div.next').click(this.nextImage.bind(this));
      this.$('.photo-overlay').find('div.prev').click(this.previousImage.bind(this));
      this.$('.image-view').swipeleft(this.nextImage.bind(this));
      this.$('.image-view').swiperight(this.previousImage.bind(this));
      this.$('.photo-overlay').find('.zoom-image-view').mousedown((function(_this) {
        return function(e) {
          var imgPosX, imgPosY, posx, posy;
          posx = e.pageX;
          posy = e.pageY;
          imgPosX = _this.$('.zoom-container').scrollLeft();
          imgPosY = _this.$('.zoom-container').scrollTop();
          return _this.$('.zoom-image-view').mousemove(function(e) {
            if (!_this.$('.zoom-image-view').hasClass('grabbing')) {
              _this.$('.zoom-image-view').addClass('grabbing');
            }
            _this.$('.zoom-container').scrollLeft(imgPosX - (e.pageX - posx));
            return _this.$('.zoom-container').scrollTop(imgPosY - (e.pageY - posy));
          });
        };
      })(this)).mouseup((function(_this) {
        return function(e) {
          return _this.$('.zoom-image-view').off('mousemove').removeClass('grabbing');
        };
      })(this));
      this.$('.photo-overlay').find('.buttons-container').tap((function(_this) {
        return function(e) {
          if (Date.now() - _this._lastTap <= 500) {
            return _this.zoomImage();
          } else {
            return _this._lastTap = Date.now();
          }
        };
      })(this));
      this.$('.photo-overlay').find('.zoom-image-view').taphold((function(_this) {
        return function(e) {
          if (!_this.$('.zoom-image-view').hasClass('grabbing')) {
            return _this.hideZoomImage();
          }
        };
      })(this));
      return this._lastTap = Date.now();
    };

    FlickrGallery.prototype.$ = function(selector) {
      return $(this.container).find(selector);
    };

    return FlickrGallery;

  })();

  window.FlickrGallery = FlickrGallery;

  if (window.location.origin.indexOf('localhost:4000') !== -1 || window.location.origin.indexOf('melchor9000') !== -1) {
    window.melchordegaleria = new FlickrGallery({
      userId: '142458589@N03',
      photosetId: '72157667134867210',
      container: $('.container')
    });
  }

}).call(this);
