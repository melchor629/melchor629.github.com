// Generated by CoffeeScript 1.10.0
(function() {
  var FlickrGallery;

  FlickrGallery = (function() {
    function FlickrGallery(opt) {
      this.photosPerPage = opt.photosPerPage || 12;
      this.container = opt.container || $('.gallery-container') || $('#gallery-container');
      this.userId = opt.userId;
      this.photosetId = opt.photosetId;
      if (!this.userId) {
        throw "userId is not set for FlickrGallery";
      }
      if (!this.photosetId) {
        throw "photosetId is not set for FlickrGallery";
      }
      if (!this.container) {
        throw "Container not found, select a valid one";
      }
      this.page = 0;
      this.totalPages = 1;
      this.loadingMorePhotos = false;
      this.photos = [];
      this.photoInfo = {};
      this.currentPhoto = null;
      this._setUpListeners();
      this.loadMorePhotos();
    }

    FlickrGallery.prototype.loadMorePhotos = function() {
      if (this.page === this.totalPages) {
        $('.load-spin-container').hide();
        return;
      }
      this.loadingMorePhotos = true;
      this.page++;
      return flickr.photosets.getPhotos({
        user_id: this.userId,
        photoset_id: this.photosetId,
        per_page: this.photosPerPage,
        page: this.page
      }, (function(_this) {
        return function(json) {
          var clearFixClasses, i, len, photo, photoNum, ref;
          _this.totalPages = json.photoset.pages;
          photoNum = 0;
          ref = json.photoset.photo;
          for (i = 0, len = ref.length; i < len; i++) {
            photo = ref[i];
            _this.photos.push(photo);
            clearFixClasses = '.visible-xs-block';
            if (photoNum % 2) {
              clearFixClasses += ' .visible-sm-block';
            } else if (photoNum % 3) {
              clearFixClasses += ' .visible-md-block .visible-lg-block';
            }
            $('.gallery').append($('<div/>').addClass('col-sm-6').addClass('col-md-4').append($('<div/>').css({
              'background-image': "url(" + (flickr.buildPhotoUrl(photo)) + ")"
            }).append($('<div/>').append($('<p/>').text(photo.title).addClass('photo-title'))).data('num', _this.photos.length - 1).click(function(e) {
              e.preventDefault();
              _this.showPhoto($(e.delegateTarget).data('num'));
              return false;
            })));
            photoNum++;
          }
          $(window).resize();
          return _this.loadingMorePhotos = false;
        };
      })(this));
    };

    FlickrGallery.prototype.showPhoto = function(num) {
      $('body').css('overflow', 'hidden');
      $('.photo-overlay').find('img').attr('src', flickr.buildLargePhotoUrl(this.photos[num]));
      $('.photo-overlay').find('.img').css('background-image', "url('" + (flickr.buildLargePhotoUrl(this.photos[num])) + "')");
      $('.photo-overlay').find('.image-info').find('h2').text(this.photos[num].title);
      $('.photo-overlay').removeClass('hide').addClass('show');
      this._loadPhotoImage(this.photos[num]);
      this.currentPhoto = num;
      if (this.currentPhoto === 0) {
        $('.photo-overlay').find('div.left').hide();
      } else {
        $('.photo-overlay').find('div.left').show();
      }
      if (this.currentPhoto === this.photos.length - 1) {
        return $('.photo-overlay').find('div.right').hide();
      } else {
        return $('.photo-overlay').find('div.right').show();
      }
    };

    FlickrGallery.prototype.hideOverlay = function() {
      this.currentPhoto = null;
      $('body').css('overflow', 'inherit');
      $('.photo-overlay').removeClass('show');
      return setTimeout(function() {
        $('.photo-overlay').addClass('hide');
        $('.photo-overlay').find('#fecha').find('span').text('');
        return $('.photo-overlay').find('#camara').find('span').text('');
      }, 500);
    };

    FlickrGallery.prototype.toggleInfoPanel = function() {
      if ($('.photo-overlay').find('.image-info').hasClass('min-size')) {
        $('.photo-overlay').find('.image-info').removeClass('min-size');
        return $('.photo-overlay').find('.image-view').removeClass('max-size');
      } else {
        $('.photo-overlay').find('.image-info').addClass('min-size');
        return $('.photo-overlay').find('.image-view').addClass('max-size');
      }
    };

    FlickrGallery.prototype.nextImage = function() {
      if (this.currentPhoto !== null && this.currentPhoto < this.photos.length - 1) {
        return this.showPhoto(this.currentPhoto + 1);
      }
    };

    FlickrGallery.prototype.previousImage = function() {
      if (this.currentPhoto !== null && this.currentPhoto > 0) {
        return this.showPhoto(this.currentPhoto - 1);
      }
    };

    FlickrGallery.prototype._loadPhotoImage = function(photo) {
      var exifFunc, infoFunc;
      infoFunc = function(data) {
        var date, sd;
        if (data.stat === "ok") {
          sd = data.photo.dates.taken.split(/[-: ]/);
          date = new Date(sd[0], sd[1], sd[2], sd[3], sd[4], sd[5], 0);
          $('.photo-overlay').find('#descripcion').text(data.photo.description._content).show();
          $('.photo-overlay').find('#fecha').show().find('span').text(date.toLocaleString());
          return $('.photo-overlay').find('#enlace').find('a').attr('href', data.photo.urls.url[0]._content).show();
        } else {
          $('.photo-overlay').find('#descripcion').hide();
          $('.photo-overlay').find('#fecha').hide();
          return $('.photo-overlay').find('#enlace').hide();
        }
      };
      exifFunc = function(data) {
        var apertura, distFocal, exposicion, flash, i, iso, len, ref, tag;
        exposicion = null;
        apertura = null;
        iso = null;
        distFocal = null;
        flash = null;
        ref = data.photo.exif;
        for (i = 0, len = ref.length; i < len; i++) {
          tag = ref[i];
          if (tag.tagspace === 'ExifIFD') {
            if (tag.tag === 'ExposureTime') {
              exposicion = tag.raw._content;
            }
            if (tag.tag === 'FNumber') {
              apertura = tag.raw._content;
            }
            if (tag.tag === 'ISO') {
              iso = tag.raw._content;
            }
            if (tag.tag === 'FocalLength') {
              distFocal = tag.raw._content;
            }
            if (tag.tag === 'Flash') {
              flash = tag.raw._content;
            }
          }
        }
        if (data.stat === "ok") {
          $('.photo-overlay').find('#camara').show().find('span').text(data.photo.camera);
        } else {
          $('.photo-overlay').find('#camara').hide();
        }
        if (exposicion) {
          $('.photo-overlay').find('#exposicion').show().find('span').text(exposicion);
        } else {
          $('.photo-overlay').find('#exposicion').hide();
        }
        if (apertura) {
          $('.photo-overlay').find('#apertura').show().find('span').text(apertura);
        } else {
          $('.photo-overlay').find('#apertura').hide();
        }
        if (iso) {
          $('.photo-overlay').find('#iso').show().find('span').text(iso);
        } else {
          $('.photo-overlay').find('#iso').hide();
        }
        if (distFocal) {
          $('.photo-overlay').find('#dist-focal').show().find('span').text(distFocal);
        } else {
          $('.photo-overlay').find('#dist-focal').hide();
        }
        if (flash) {
          if (flash.indexOf('Off' !== -1)) {
            return $('.photo-overlay').find('#flash').show().find('span').text('Apagado, no se disparó');
          } else {
            return $('.photo-overlay').find('#flash').show().find('span').text('Encendido, se disparó');
          }
        } else {
          return $('.photo-overlay').find('#flash').hide();
        }
      };
      if (this.photoInfo[photo.id] && this.photoInfo[photo.id].info) {
        infoFunc(this.photoInfo[photo.id].info);
      } else {
        flickr.photos.getInfo({
          photo_id: photo.id,
          secret: photo.secret
        }, (function(_this) {
          return function(data) {
            infoFunc(data);
            if (_this.photoInfo[photo.id]) {
              return _this.photoInfo[photo.id].info = data;
            } else {
              return _this.photoInfo[photo.id] = {
                info: data
              };
            }
          };
        })(this));
      }
      if (this.photoInfo[photo.id] && this.photoInfo[photo.id].exif) {
        return exifFunc(this.photoInfo[photo.id].exif);
      } else {
        return flickr.photos.getExif({
          photo_id: photo.id,
          secret: photo.secret
        }, (function(_this) {
          return function(data) {
            exifFunc(data);
            if (_this.photoInfo[photo.id]) {
              return _this.photoInfo[photo.id].exif = data;
            } else {
              return _this.photoInfo[photo.id] = {
                exif: data
              };
            }
          };
        })(this));
      }
    };

    FlickrGallery.prototype._setUpListeners = function() {
      $(window).scroll((function(_this) {
        return function() {
          var bottom, sizeOfPage;
          bottom = $(window).scrollTop() + $(window).height();
          sizeOfPage = $('#wrap').height();
          if (sizeOfPage - bottom < 100 && !_this.loadingMorePhotos) {
            return _this.loadMorePhotos();
          }
        };
      })(this));
      $(window).resize(function() {
        return $('.gallery > div > div').each(function(k, v) {
          return $(v).height($(v).width());
        });
      });
      $(window).keyup((function(_this) {
        return function(e) {
          if ($('.photo-overlay').hasClass('show')) {
            if (e.keyCode === 27) {
              return _this.hideOverlay();
            } else if (e.keyCode === 39) {
              return _this.nextImage();
            } else if (e.keyCode === 37) {
              return _this.previousImage();
            } else if (e.keyCode === 32) {
              return console.log(null);
            }
          }
        };
      })(this));
      $('.photo-overlay').find('#close').click(this.hideOverlay.bind(this)).parent().find('#info').click(this.toggleInfoPanel.bind(this));
      $('.photo-overlay').find('div.next').click(this.nextImage.bind(this));
      return $('.photo-overlay').find('div.left').click(this.previousImage.bind(this));
    };

    return FlickrGallery;

  })();

  window.melchordegaleria = new FlickrGallery({
    userId: '107436442@N02',
    photosetId: '72157646899786200',
    container: $('.container')
  });

}).call(this);
